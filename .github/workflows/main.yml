name: MimeKit CI/CD Pipeline

on: [push, pull_request, workflow_dispatch]

jobs:
  ci:
    runs-on: windows-latest
    strategy:
      matrix:
        build-configuration: [ Debug, Release ]
    env:
      SOLUTION_PATH: .\MimeKit.sln
      BUILD_PLATFORM: Any CPU
      BUILD_CONFIGURATION: ${{ matrix.build-configuration }}
      LATEST_VERSION: 2.10.1$(Rev:.r)
    steps:
      - name: Setup MSBuild
        id: setup_msbuild
        uses: microsoft/setup-msbuild@v1.0.2

      - name: Checkout repository
        id: checkout_repo
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive
          fetch-depth: 0

      - name: Run NuGet restore
        id: run_nuget_restore
        shell: pwsh
        run: |
          nuget restore $env:SOLUTION_PATH

      - name: Build solution
        id: build_solution
        shell: pwsh
        run: |
          msbuild $env:SOLUTION_PATH `
          /p:Platform=$env:BUILD_PLATFORM `
          /p:Configuration=$env:BUILD_CONFIGURATION

      - if: matrix.build-configuration == 'Release'
        name: Run unit tests
        id: run_unit_tests
        shell: pwsh
        run: |
          & .\azure-test-runner.ps1

      - if: matrix.build-configuration == 'Release'
        name: Upload unit tests results as artifact
        id: upload_test_results
        uses: actions/upload-artifact@v1
        with:
          name: Unit tests results
          path: TestResult.xml

      - if: matrix.build-configuration == 'Release'
        name: Create NuGet package
        id: create_nuget_package
        run: |
          nuget pack .\nuget\MimeKit.nuspec

      - if: matrix.build-configuration == 'Release'
        name: Upload NuGet package as artifact
        id: upload_nuget_package
        uses: actions/upload-artifact@v1
        with:
          name: MimeKit.2.10.1.nupkg
          path: MimeKit.2.10.1.nupkg          

# Built with ‚ù§ by [Pipeline Foundation](https://pipeline.foundation)